<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Users</title>
    <style>
        .red-button {
            padding: 3px 7px;
            background-color: #ff0000;
            color: white;
            border: #000000;
            border-style: solid;
            border-width: 1px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            margin-right: 5px;
        }

        .full-width-button {
            width: 20%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: black;
            border-style: solid;
            border-width: 1px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<header class="bg-dark text-white p-1 d-flex justify-content-between">
    <div class="ms-3">
        <strong>
            <th:block th:text="${user.username}"></th:block>
        </strong>
        with roles:
        <span>
            <span th:each="role, iterStat : ${user.roles}">
                <span th:text="${role.name}"></span>
                <span th:if="${iterStat.index < iterStat.size - 1}"> </span>
            </span>
        </span>
    </div>
    <form th:action="@{/logout}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="btn btn-link text-secondary text-decoration-none logout-button" type="submit">Logout</button>
    </form>
</header>

<h1>Admin panel</h1>
<div>
    <br>
    <div style="width: 100%;">
        <input type="button" value="ADD NEW USER" onclick="window.location.href = 'admin/addNewUser'"
               class="full-width-button"/>
    </div>
    <br>
    <table class="table table-striped">
        <thead>
        <tr>
            <th scope="col">ID</th>
            <th scope="col">USERNAME</th>
            <th scope="col">EMAIL</th>
            <th scope="col">ROLES</th>
            <th scope="col">EDIT</th>
            <th scope="col">DELETE</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${users}">
            <td th:utext="${user.id}">...</td>
            <td th:utext="${user.username}">...</td>
            <td th:utext="${user.email}">...</td>
            <td>
                <span>
                    <span th:each="role, iterStat : ${user.roles}">
                        <span th:text="${role.name}"></span>
                        <span th:if="${iterStat.index < iterStat.size - 1}"> </span>
                    </span>
                </span>
            </td>
            <td>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editUserModal"
                        th:attr="data-user-id=${user.id}, data-user-username=${user.username}, data-user-email=${user.email}">
                    EDIT
                </button>
            </td>
            <td>
                <div style="display: inline-block; margin-right: 10px;">
                    <form th:action="@{/admin/deleteUser}" method="post">
                        <input type="hidden" name="_method" value="DELETE">
                        <input type="hidden" name="id" th:value="${user.id}"/>
                        <button type="submit" class="red-button">DELETE</button>
                    </form>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3 row">
                        <div class="col-lg-7 mx-auto d-flex flex-column align-items-center">
                            <label for="editUserId" class="form-label fw-bold">User ID</label>
                            <input type="text" class="form-control" id="editUserId" disabled>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-lg-7 mx-auto d-flex flex-column align-items-center">
                            <label for="editEmail" class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" id="editEmail">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-lg-7 mx-auto d-flex flex-column align-items-center">
                            <label for="editPassword" class="form-label fw-bold">Password</label>
                            <input type="password" class="form-control" id="editPassword">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-lg-7 mx-auto d-flex flex-column align-items-center">
                            <label for="editRole" class="form-label fw-bold">Role</label>
                            <select class="form-select" id="editRole" multiple size="2">
                                <option value="Admin">ADMIN</option>
                                <option value="User">USER</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary save-changes">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>


<script>
    $('#editUserModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const userId = button.data('user-id');
        const username = button.data('user-username');
        const email = button.data('user-email');

        const modal = $(this);
        modal.find('#userId').val(userId);
        modal.find('#username').val(username);
        modal.find('#email').val(email);
    });

    function updateUser() {
        const form = document.getElementById('updateUserForm');
        const userId = form.userId.value;
        const username = form.username.value;
        const password = form.password.value;
        const email = form.email.value;
        const roles = [];
        form.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            roles.push(checkbox.value);
        });

        const formData = new FormData();
        formData.append('id', userId);
        formData.append('username', username);
        formData.append('password', password);
        formData.append('email', email);
        formData.append('roles', roles);

        fetch('/admin/updateUser', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User updated successfully!');
                    $('#editUserModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error updating user: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error updating user: ' + error);
            });
    }
</script>
</body>
</html>